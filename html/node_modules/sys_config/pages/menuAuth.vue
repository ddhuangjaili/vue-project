<template>
  <div>
    <el-row :gutter="5">
      <el-col :span="10">
        <div class="menu-mng-left">
          <el-tabs v-model="type" type="card" @tab-click="tabSwitch">
            <el-tab-pane label="角色" name="role" v-if="optAuth.setAuth">
              <el-form :inline="true" :model="roles.search" class="demo-form-inline">
                <el-form-item>
                  <el-input v-model="roles.search.name" placeholder="角色名称"></el-input>
                </el-form-item>
                <el-form-item>
                  <el-button type="primary" @click="getRoles">查询</el-button>
                </el-form-item>
              </el-form>
              <el-table
                highlight-current-row
                v-loading.body="loading"
                :data="roles.items"
                @row-click="selectRole"
                border
                style="width: 100%">
                <el-table-column type="index" width="60">
                </el-table-column>
                <el-table-column
                  :show-overflow-tooltip="true"
                  prop="name"
                  label="角色名称"
                  width="200" sortable>
                </el-table-column>
                <el-table-column
                  :show-overflow-tooltip="true"
                  prop="code"
                  label="角色代码"
                  width="150" sortable>
                </el-table-column>
                <el-table-column
                  :show-overflow-tooltip="true"
                  prop="parentCode"
                  label="父角色编码"
                  min-width="150"
                  sortable>
                </el-table-column>
              </el-table>
            </el-tab-pane>
            <el-tab-pane label="用户" name="user" v-if="optAuth.setUserAuth">
              <el-form :inline="true" :model="users.search" class="demo-form-inline">
                <el-form-item>
                  <el-select v-model="users.search.roleCode" clearable placeholder="角色">
                    <el-option v-for="(r, i) in roles.items" :value="r.code" :label="r.name" :key="'search-role-'+ r.code">
                      <span v-for="i in r.depth">&nbsp;</span>{{r.name}}
                    </el-option>
                  </el-select>
                </el-form-item>
                <el-form-item>
                  <el-input v-model="users.search.loginName" placeholder="登录账号"></el-input>
                </el-form-item>
                <el-form-item>
                  <el-button type="primary" @click="getUsers()">查询</el-button>
                </el-form-item>
              </el-form>
              <el-table
                highlight-current-row
                v-loading.body="loading"
                :data="users.items"
                @row-click="selectUser"
                border
                style="width: 100%">
                <el-table-column type="index" width="60">
                </el-table-column>
                <el-table-column
                  prop="loginName"
                  label="登录账号"
                  width="200" sortable>
                </el-table-column>
                <el-table-column
                  prop="roleCode"
                  label="角色"
                  width="150" sortable>
                </el-table-column>
                <el-table-column
                  prop="status"
                  label="状态"
                  :formatter="status">
                </el-table-column>
              </el-table>
              <el-pagination class="pull-right"
                             @size-change="handleSizeChange"
                             @current-change="handleCurrentChange"
                             :current-page="users.pager.pageNo"
                             :page-sizes="[10, 20, 50, 100]"
                             :page-size="users.pager.pageSize"
                             layout="total, sizes, prev, pager, next, jumper"
                             :total="users.pager.total">
              </el-pagination>

            </el-tab-pane>
          </el-tabs>
        </div>
      </el-col>

      <el-col :span="14">
        <div class="menu-mng-right">
          <div class="btn-row">
            系统类别：<el-select @change="systemFlagChange" class="select-flag" v-model="systemFlag" filterable placeholder="标示">
            <el-option v-for="(c, key) in systemFlags" :label="c.name" :value="c.code"
                       :key="'systemFlag-'+ c.code"></el-option>
          </el-select>
            <el-button v-show="(this.type === 'role' && optAuth.setAuth) || (this.type === 'user' && optAuth.setUserAuth)" type="primary" size="small" @click="toSave()">
              <i class="icon-floppy"></i>&nbsp;&nbsp;保存
            </el-button>
          </div>
          <div class="tree-block" :style="{'height': (height - 60) + 'px'}">
            <el-tree
              v-loading="tree.loading"
              show-checkbox
              :data="operations"
              node-key="id"
              ref="tree"
              highlight-current
              :render-content="renderContent"
              :props="defaultProps">
            </el-tree>
          </div>
        </div>
      </el-col>
    </el-row>
  </div>
</template>

<script>
  import api from '../api';
  import bsmp from 'bsmp_main';
  export default {
    name: 'menuAuth',
    props: {
      height: {
        type: Number
      }
    },
    data() {
      return {
        loading: true,
        type: 'role',
        roles: {
          search: {
            name: ''
          },
          items: []
        },
        users: {
          search: {
            roleCode: '',
            loginName: ''
          },
          items: [],
          pager: {
            pageSize: 20,
            pageNo: 1,
            total: 0
          }
        },
        items: null,
        tree: {
          loading: false
        },
        operations: null,
        checkedKeys: [],
        dataMap: {},
        defaultProps: {
          children: 'children',
          label: 'label'
        },
        selectRoleCode: null,
        systemFlags: [],
        systemFlag: null,
        statusMap: {
          0: '启动',
          1: '停用'
        },
        selectUserName: null
      };
    },
    mounted () {
      if (!this.optAuth.setAuth) {
        this.type = 'user';
      }
      // 查询系统标示
      this.getDictByPid('system_flag').then(() => {
        this.query();
      });
    },
    computed: {
      optAuth() {
        return bsmp.util.mapAuth({
          search: 'sys_config_roleMng_view',
          userMenu: 'sys_config_menuAuth_userMenu',
          setAuth: 'sys_config_menuAuth_setAuth',
          setUserAuth: 'sys_config_menuAuth_setUserAuth'
        });
      },
      company() {
        return this.$store.getters.company;
      }
    },
    methods: {
      tabSwitch() {
        this.query();
        this.operations = [];
      },
      query() {
        if (this.type === 'role') {
          this.getRoles();
        } else if (this.type === 'user') {
          this.getRoles().then(() => {
            this.users.search.roleCode = this.roles.items && this.roles.items.length ? this.roles.items[0].code : '';
            this.getUsers();
          });
        }
      },
      /**
       * 格式化有效性
       * @param row
       * @returns {string}
       */
      status (row) {
        return typeof row.status !== 'undefined' ? this.statusMap[row.status] : '';
      },
      getDictByPid (code) {
        return api.getDictByPCode(code).then((res) => {
          let data = res.data;
          if (data && data.code === '0') {
            this.systemFlags = data.data;
            if (this.systemFlags && this.systemFlags.length) {
              this.systemFlag = this.systemFlags[0].code;
            }
          }
        });
      },
      renderContent(h, {node, data, store}) {
        return this.$createElement('menuTreeItem', {
          props: {
            node,
            type: 2
          }
        });
      },
      selectRole (row) {
        this.selectRoleCode = row.code;
        this.operations = [];
        this.getMenus();
      },
      selectUser (row) {
        this.selectUserName = row.loginName;
        this.operations = [];
        this.getUserMenus();
      },
      systemFlagChange() {
        if (this.type === 'role' && this.selectRoleCode) {
          this.getMenus()
        } else if (this.type === 'user' && this.selectUserName) {
          this.getUserMenus();
        }
      },
      toSave () {
        let nodeMap = this.dataMap;
        let keyMap = {}, keys = [], parent = null;

        // 递归选中父节点
        function getCheckedParent(parentCode) {
          keyMap[parentCode] = 1;
          parent = nodeMap[parentCode];
          if (parent && parent.parentCode) {
            getCheckedParent(parent.parentCode);
          }
        }

        if (this.$refs.tree.getCheckedNodes().length) {
          this.$refs.tree.getCheckedNodes().forEach((node) => {
            keyMap[node.id] = 1;
            if (node.parentCode) {
              getCheckedParent(node.parentCode);
            }
          });
          for (let key in keyMap) {
            keys.push(key);
          }
        }
        let params = {
          systemFlag: this.systemFlag,
          menuCodes: keys.join(',')
        };
        if (this.company) {
          params.companyId = this.company.companyId
        }
        let method = null;
        if (this.type === 'role') {
          params.roleCode = this.selectRoleCode;
          method = api.authRoleMenus(params);
        } else if (this.type === 'user') {
          params.loginName = this.selectUserName;
          method = api.authUserMenus(params);
        }
        method && method.then((res) => {
          let data = res.data;
          if (data && data.code === '0') {
            this.$message({
              type: 'success',
              message: '操作成功!'
            });

            // 记录日志
            bsmp.log({
              component: 'sys_config',
              type: 'auth',
              content: `[MenuAuth] params: ${JSON.stringify(params)}`
            });
          }
        });
      },

      getMenus () {
        this.checkedKeys = [];
        if (!this.systemFlag) {
          this.$message.warning('请选择系统类别！');
          return;
        }
        let params = {
          roleCode: this.selectRoleCode,
          hasAuth: false,
          systemFlag: this.systemFlag
        };
        if (this.company) {
          params.companyId = this.company.companyId
        }

        this.tree.loading = true;
        api.getMenuList(params).then((res) => {
          let data = res.data;
          if (data && data.code === '0') {
            this.items = data.data;
            this.handleOperation();

            // 选中权限
            this.$refs.tree.setCheckedKeys(this.checkedKeys);
            this.tree.loading = false;
          }
        });
      },
      getUserMenus () {
        this.checkedKeys = [];
        if (!this.systemFlag) {
          this.$message.warning('请选择系统类别！');
          return;
        }
        let params = {
          loginName: this.selectUserName,
          systemFlag: this.systemFlag
        };

        this.tree.loading = true;
        api.getUserMenuList(params).then((res) => {
          let data = res.data;
          if (data && data.code === '0') {
            this.items = data.data;
            this.handleOperation();

            // 选中权限
            this.$refs.tree.setCheckedKeys(this.checkedKeys);
            this.tree.loading = false;
          }
        });
      },
      handleOperation () {
        let results = [], item, result, children;
        for (let i = 0, len = this.items.length; i < len; i++) {
          item = this.items[i];
          this.dataMap[item.code] = item;
          result = {
            id: item.code,
            label: item.name,
            type: item.type
          };
          if (item.children && item.children.length) {
            children = this.getChildren(item.children, result.id);
            if (children.length) {
              result.children = children;
            }
          }
          results.push(result);
        }

        this.operations = results;
      },
      getChildren (items, code) {
        let results = [], result, item, children;
        for (let i = 0, len = items.length; i < len; i++) {
          item = items[i];
          this.dataMap[item.code] = item;
          result = {
            id: item.code,
            label: item.name,
            parentCode: code,
            type: item.type
          };

          if (item.auth === 1) {
            this.checkedKeys.push(item.code);
          }

          if (item.children && item.children.length) {
            children = this.getChildren(item.children, result.id);
            if (children.length) {
              result.children = children;
            }
          }
          results.push(result);
        }
        return results;
      },
      /**
       * 查询
       */
      getRoles () {
        this.loading = true;
        let params = Object.assign({}, this.search);
        if (this.company) {
          params.companyId = this.company.companyId
        }
        return api.getRoleList(params).then((res) => {
          this.loading = false;
          let data = res.data;
          if (data && data.code === '0') {
            this.roles.items = data.data;
          }
        });
      },
      getUsers () {
        if (!this.optAuth.userMenu) {
          this.$message.warning('无权限操作用户菜单！');
          return false;
        }
        this.loading = true;
        let params = {};
        if (this.users.search.roleCode) {
          params.roleCode = this.users.search.roleCode;
        }
        if (this.users.search.loginName) {
          params.loginName = this.users.search.loginName;
        }
        if (this.company) {
          params.companyId = this.company.companyId
        }
        params = Object.assign({}, params, this.users.pager);
        api.getUserList(params).then((res) => {
          this.loading = false;
          let data = res.data;
          if (data && data.code === '0') {
            this.users.items = data.data.data;
            this.users.pager = Object.assign({}, this.users.pager,
              {
                pageNo: data.data.pageNo,
                total: data.data.total
              });
          }
        }).catch(e => {
          this.loading = false;
        });
      },
      /**
       * 每页显示条数变化
       * @param val
       */
      handleSizeChange (val) {
        this.users.pager.pageSize = val;
        this.getUsers();
      },

      /**
       * 页码变化
       * @param val
       */
      handleCurrentChange (val) {
        if (this.users.pager.pageNo) {
          this.users.pager.pageNo = val;
          this.getUsers();
        }
      }
    },
    watch: {
      'company': function (company) {
        if (company) {
          this.query();
        }
      }
    }
  };
</script>
<style lang="stylus" scoped>
  .menu-mng-left
    border: 1px solid #ccc

  .demo-form-inline
    padding: 5px 0 0 5px
    .tree-block
      height: 750px

  .menu-mng-right
    border: 1px solid #ccc
    .btn-row
      height: 50px
      padding: 5px
    .tree-block
      height: 750px
      overflow:scroll
</style>
