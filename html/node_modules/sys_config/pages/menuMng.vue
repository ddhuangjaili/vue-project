<template>
  <div>
    <el-row :gutter="5">
      <el-col :span="7">
        <div class="menu-mng-left">
          <div class="btn-row">
            系统类别：<el-select @change="changeFlag" class="select-flag" v-model="systemFlag" filterable placeholder="标示">
            <el-option v-for="(c, key) in systemFlags" :label="c.name" :value="c.code"
                       :key="'systemFlag-'+ c.code"></el-option>
          </el-select>
            <el-button v-show="optAuth.search" @click="query()" title="刷新" type="primary" size="small" class="pull-right">
              <i class="icon-arrows-cw"></i>
            </el-button>
            <el-button v-show="optAuth.add" @click="showDialog('')" title="新建" type="primary" size="small" class="pull-right">
              <i class="icon-plus"></i>
            </el-button>
          </div>
          <div class="tree-block" :style="{'height': (height - 60) + 'px'}">
            <el-tree
              v-loading="loading"
              :data="operations"
              node-key="id"
              ref="tree"
              highlight-current
              @node-click="handleNodeClick"
              :render-content="renderContent"
              :props="defaultProps">
            </el-tree>
          </div>
        </div>
      </el-col>
      <el-col :span="17">
        <div class="menu-mng-right">
          <div class="opt-block" :style="{'height': (height - 10) + 'px'}">
            <el-form ref="optForm" :model="form" :rules="rules" label-width="120px" class="dialog-form"
                     v-show="form.id">
              <el-row :gutter="20">
                <el-col :span="24">
                  <el-form-item label="上级菜单：">
                    <el-cascader
                      :options="options"
                      :disabled="form.type === 'func'"
                      v-model="form.parentKeys"
                    ></el-cascader>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20">
                <el-col :span="8">
                  <el-form-item label="类型：">
                    <el-select v-model="form.type" placeholder="类型">
                      <el-option v-for="(val, key) in typeMap" :label="val" :value="key"
                                 :key="'form-type-'+ key"></el-option>
                    </el-select>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item label="编号：" prop="code">
                    <el-input v-model="form.code" auto-complete="off"></el-input>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20">
                <el-col :span="8">
                  <el-form-item label="排序：" prop="sort">
                    <el-input-number v-model="form.sort" :min="0"></el-input-number>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item label="状态：" prop="status">
                    <el-select v-model="form.status" filterable placeholder="状态">
                      <el-option v-for="(val, key) in statusMap" :label="val" :value="key"
                                 :key="'form-status-'+ key"></el-option>
                    </el-select>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20">
                <el-col :span="8">
                  <el-form-item label="名称：" prop="name">
                    <el-input v-model="form.name" auto-complete="off"></el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item label="英文名：" prop="nameEN">
                    <el-input v-model="form.nameEN" auto-complete="off"></el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item label="繁体名：" prop="nameTW">
                    <el-input v-model="form.nameTW" auto-complete="off"></el-input>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="URI：" prop="uri">
                    <el-input v-model="form.uri" auto-complete="off"></el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="备注：" prop="remark">
                    <el-input v-model="form.remark" type="textarea"></el-input>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20" v-show="optAuth.edit">
                <el-col :offset="10" :span="14">
                  <el-button @click="submitForm(1)" type="primary">保 存</el-button>
                  <el-button @click="resetForm('optForm')">重 置</el-button>
                </el-col>
              </el-row>
            </el-form>
          </div>
        </div>
      </el-col>
    </el-row>

    <!-- 弹窗框 -->
    <el-dialog :title="dialog.title" v-model="dialog.show" :close-on-press-escape="false" :close-on-click-modal="false">
      <el-form ref="addForm" :model="dialog.form" :rules="rules" label-width="80px" class="dialog-form">
        <el-row :gutter="20">
          <el-col :span="24">
            <el-form-item label="上级菜单：">
              <span v-show="dialog.form.parent.name">{{dialog.form.parent.name}}</span>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="类型：" prop="type">
              <el-select v-model="dialog.form.type" placeholder="类型">
                <el-option v-for="(val, key) in typeMap" :label="val" :value="key" :key="'add-type-'+ key"></el-option>
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="编号：" prop="code">
              <el-input v-model="dialog.form.code" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="排序：" prop="sort">
              <el-input-number v-model="dialog.form.sort" :min="0"></el-input-number>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="状态：" prop="status">
              <el-select v-model="dialog.form.status" filterable placeholder="状态">
                <el-option v-for="(val, key) in statusMap" :label="val" :value="key"
                           :key="'add-form-status-'+ key"></el-option>
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="名称：" prop="name">
              <el-input v-model="dialog.form.name" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="英文名：" prop="nameEN">
              <el-input v-model="dialog.form.nameEN" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="繁体名：" prop="nameTW">
              <el-input v-model="dialog.form.nameTW" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="URI：" prop="uri">
              <el-input v-model="dialog.form.uri" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="备注：" prop="remark">
              <el-input v-model="dialog.form.remark" type="textarea"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20" v-show="optAuth.add">
          <el-col :offset="10" :span="14">
            <el-button @click="submitForm(2)" type="primary">保 存</el-button>
            <el-button @click="resetForm('addForm')">重 置</el-button>
          </el-col>
        </el-row>
      </el-form>
    </el-dialog>
    <!-- /弹窗框 -->
  </div>
</template>

<script>
  import api from '../api';
  import bsmp from 'bsmp_main';
  export default {
    name: 'menuMng',
    props: {
      height: {
        type: Number
      }
    },
    data() {
      return {
        loading: true,
        items: null,
        operations: [],
        options: [],
        systemFlags: [],
        systemFlag: null,
        dataMap: {},
        form: {
          id: null,
          name: '',
          nameEN: '',
          nameTW: '',
          code: '',
          uri: '',
          type: 'menu',
          parentCode: '',
          sort: null,
          action: '',
          systemFlag: null,
          remark: '',
          status: null,
          parentKeys: []
        },
        dialog: {
          show: false,
          title: '新增',
          form: {
            name: '',
            nameEN: '',
            nameTW: '',
            code: '',
            uri: '',
            type: 'menu',
            parentCode: '',
            sort: null,
            action: '',
            systemFlag: null,
            remark: '',
            status: null,
            parent: {
              name: ''
            }
          }
        },
        rules: rules,
        defaultProps: {
          children: 'children',
          label: 'label'
        },
        typeMap: {
          'menu': '菜单',
          'func': '功能'
        },
        statusMap: {
          0: '启动',
          1: '停用'
        },
        actionMap: {
          'add': '新增',
          'delete': '删除',
          'edit': '修改',
          'search': '查询',
          'login': '登录',
          'logout': '退出',
          'other': '其他'
        }
      };
    },
    mounted () {
      // 查询系统标示
      this.getDictByPid('system_flag').then(() => {
        this.query();
      });
    },
    computed: {
      optAuth() {
        return bsmp.util.mapAuth({
          search: 'sys_config_menuMng_view',
          add: 'sys_config_menuMng_add',
          edit: 'sys_config_menuMng_edit',
          del: 'sys_config_menuMng_delete'
        });
      }
    },
    methods: {
      /**
       * 系统标示切换
       * */
      changeFlag() {
        // 不显示右侧的编辑Form
        this.form.id = null;
        this.items = null;
        this.operations = [];
        this.options = [];

        // 查询菜单
        this.query();
      },
      /**
       * 删除
       * */
      deleteItem (code) {
        this.$confirm('确定要删除该条记录?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          // 删除
          api.removeMenu(this.dataMap[code].id).then((res) => {
            let data = res.data;
            if (data && data.code === '0') {
              this.$message({
                type: 'success',
                message: '删除成功!'
              });
              this.query();

              // 记录日志
              bsmp.log({
                component: 'sys_config',
                type: 'delete',
                content: `[Menu] params: ${JSON.stringify({id: this.dataMap[code].id})}`
              });
            }
          });
        }).catch(e => {
        });
      },
      submitForm (type) {
        if (type === 1) {
          this.$refs['optForm'].validate((valid) => {
            if (valid) {
              // 修改
              let params = {
                id: this.form.id,
                type: this.form.type,
                code: this.form.code,
                name: this.form.name,
                nameEN: this.form.nameEN,
                nameTW: this.form.nameTW,
                uri: this.form.uri,
                parentCode: !this.form.parentKeys.length ? '' : this.form.parentKeys[this.form.parentKeys.length - 1],
                sort: this.form.sort,
                remark: this.form.remark,
                status: this.form.status
              };
              api.editMenu(params).then((res) => {
                let data = res.data;
                if (data && data.code === '0') {
                  this.$message({
                    type: 'success',
                    message: '修改成功!'
                  });
                  this.query();

                  // 记录日志
                  bsmp.log({
                    component: 'sys_config',
                    type: 'modify',
                    content: `[Menu] params: ${JSON.stringify(params)}`
                  });
                }
              });
            }
          });
        } else if (type === 2) {
          this.$refs['addForm'].validate((valid) => {
            if (valid) {
              // 新增
              let params = {
                type: this.dialog.form.type,
                code: this.dialog.form.code,
                name: this.dialog.form.name,
                nameEN: this.dialog.form.nameEN,
                nameTW: this.dialog.form.nameTW,
                uri: this.dialog.form.uri,
                systemFlag: this.systemFlag,
                action: this.dialog.form.action,
                parentCode: this.dialog.form.parentCode,
                sort: this.dialog.form.sort,
                remark: this.dialog.form.remark,
                status: this.dialog.form.status
              };
              if (this.dialog.form.resourceId) {
                params.resourceId = this.dialog.form.resourceId;
              }
              api.addMenu(params).then((res) => {
                let data = res.data;
                if (data && data.code === '0') {
                  this.$message({
                    type: 'success',
                    message: '新增成功!'
                  });

                  this.dialog.show = false;
                  this.query();

                  // 记录日志
                  bsmp.log({
                    component: 'sys_config',
                    type: 'add',
                    content: `[Menu] params: ${JSON.stringify(params)}`
                  });
                }
              });
            }
          });
        }
      },
      /**
       * 显示弹窗
       * */
      showDialog (parentCode) {
        if (this.$refs['addForm'] && this.$refs['addForm'].resetFields) {
          this.$refs['addForm'].resetFields();
        }

        this.dialog.form = {
          name: '',
          nameEN: '',
          nameTW: '',
          code: '',
          uri: '',
          type: 'menu',
          parentCode: parentCode,
          sort: null,
          action: '',
          systemFlag: null,
          remark: '',
          status: null,
          parent: this.dataMap[parentCode] || {name: ''}
        };

        this.dialog.show = true;
      },
      getParentKey(code) {
        let parent = this.dataMap[code];
        if (parent) {
          this.form.parentKeys.unshift(parent.code);
          if (parent.parentCode) {
            this.getParentKey(parent.parentCode);
          }
        }
      },
      handleNodeClick (data) {
        this.form = Object.assign({}, this.dataMap[data.id]);
        this.form.status = this.form.status + '';
        this.form.parentKeys = [];
        this.getParentKey(this.form.parentCode);
      },
      renderContent(h, {node, data, store}) {
        return this.$createElement('menuTreeItem', {
          props: {
            node,
            type: 1
          },
          on: {
            'plus': (data) => {
              this.showDialog(data.data.id);
            },
            'trash': (data) => {
              if (this.optAuth.del) {
                this.deleteItem(data.data.id);
              } else {
                this.$message({
                  type: 'warning',
                  message: '无权限操作!'
                });
              }
            }
          }
        });
      },
      getDictByPid (code) {
        return api.getDictByPCode(code).then((res) => {
          let data = res.data;
          if (data && data.code === '0') {
            this.systemFlags = data.data;
            if (this.systemFlags && this.systemFlags.length) {
              this.systemFlag = this.systemFlags[0].code;
            }
          }
        });
      },
      /**
       * 查询
       */
      query () {
        this.loading = true;
        api.getMenuList({systemFlag: this.systemFlag}).then((res) => {
          this.loading = false;
          let data = res.data;
          if (data && data.code === '0') {
            this.items = data.data;
            this.operations = this.handleOperation(1);
            this.options = this.handleOperation(2);
          }
        }).catch(e => {
          this.loading = false;
        });
      },
      handleOperation (type) {
        let results = [], item, result, children;
        for (let i = 0, len = this.items.length; i < len; i++) {
          item = this.items[i];
          this.dataMap[item.code] = item;
          result = {
            id: item.code,
            value: item.code,
            label: item.name,
            type: item.type
          };
          if (item.children && item.children.length) {
            children = this.getChildren(item.children, result.id, type);
            if (children.length) {
              result.children = children;
            }
          }

          if (type === 1 || (type === 2 && result.type === 'menu')) {
            results.push(result);
          }
        }

        return results;
      },
      getChildren (items, code, type) {
        let results = [], result, item, children;
        for (let i = 0, len = items.length; i < len; i++) {
          item = items[i];
          this.dataMap[item.code] = item;
          result = {
            id: item.code,
            value: item.code,
            label: item.name,
            parentCode: code,
            type: item.type
          };

          if (item.children && item.children.length) {
            children = this.getChildren(item.children, result.id, type);
            if (children.length) {
              result.children = children;
            }
          }

          if (type === 1 || (type === 2 && result.type === 'menu')) {
            results.push(result);
          }
        }
        return results;
      },
      resetForm(formName) {
        this.$refs[formName].resetFields();
      }
    }
  };
  // 表单规则
  let rules = {
    code: [
      {required: true, message: '请输入菜单编号', trigger: 'blur'}
    ],
    name: [
      {required: true, message: '请输入菜单名称', trigger: 'blur'}
    ],
//    systemFlag: [
//      {required: true, message: '请选择系统标示', trigger: 'change'}
//    ],
    sort: [
      {required: true, type: 'number', message: '请输入次序', trigger: 'blur'}
    ],
    status: [
      {required: true, message: '请选择状态', trigger: 'change'}
    ]
  };
</script>
<style lang="stylus" scoped>
  .menu-mng-left
    border: 1px solid #ccc
    .btn-row
      height: 50px
      padding: 5px
      button
        margin: 0 5px
    .tree-block
      height: 750px
      overflow:scroll

  .menu-mng-right
    border: 1px solid #ccc
    .opt-block
      height: 800px
</style>
