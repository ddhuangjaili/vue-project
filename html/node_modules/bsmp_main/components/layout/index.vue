<template>
  <div class="page-container">
    <Headers @switchCompany="switchCompany"
             @logout="logout"
             @showPwdDialog="showPwdDialog"
             @switchModule="switchModule"
             :loginUserInfo="loginUserInfo"
             :companies="companies"
             :company="company"
             :modules="modules"></Headers>
    <div class="page-sidebar" :class="{'menu-compact': collapse}">
      <Menus :menus="menus" :modules="modules" :loginUserInfo="loginUserInfo" :collapse="collapse"
             @breadsChange="handleBreads"
             @switchModule="switchModule"
             @collapseChange="handleCollapse"></Menus>
    </div>
    <div class="page-content">
      <Breadcrumb :breads="breads"></Breadcrumb>
      <div id="container" class="container">
        <transition name="fade" mode="out-in">
          <router-view :height="height"></router-view>
        </transition>
      </div>
    </div>

    <!-- 弹窗框 -->
    <el-dialog title="修改密码" v-model="pwd.show" size="tiny"
               :close-on-press-escape="false" :close-on-click-modal="false">
      <el-form ref="pwdForm" :model="pwd.form" label-width="120px" class="dialog-form">
        <el-row :gutter="20">
          <el-col :span="24">
            <el-form-item prop="oldPwd" label="旧 密 码："
                          :rules="{required: true, message: '旧密码不能为空', trigger: 'blur'}">
              <el-input type="password" v-model="pwd.form.oldPwd" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="24">
            <el-form-item prop="newPwd" label="新 密 码："
                          :rules="{required: true, message: '新密码不能为空', trigger: 'blur'}">
              <el-input type="password" v-model="pwd.form.newPwd" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="24">
            <el-form-item prop="okPwd" label="确认密码："
                          :rules="{required: true, message: '确认密码不能为空', trigger: 'blur'}">
              <el-input type="password" v-model="pwd.form.okPwd" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="submitPwdForm()" type="primary">保 存</el-button>
        <el-button @click="pwd.show = false">取 消</el-button>
      </div>
    </el-dialog>
    <!-- /弹窗框 -->

  </div>
</template>
<script>
  import Headers from './Headers.vue';
  import Menus from './Menus.vue';
  import Breadcrumb from './Breadcrumb.vue';
  import api from '../../api';
  export default {
    name: 'layout',
    components: {Headers, Menus, Breadcrumb},
    props: {
      menus: {
        type: Array
      },
      modules: {
        type: Object
      },
      loginUserInfo: {
        type: Object
      },
      companies: {
        type: Array
      },
      company: {
        type: Object
      }
    },
    data () {
      return {
        breads: [], // 面包屑菜单组合
        collapse: false, // 菜单收起
        height: 600,
        pwd: {
          show: false,
          form: {
            oldPwd: '',
            newPwd: '',
            okPwd: ''
          }
        }
      };
    },
    mounted () {
      let method = this.setCtxHeight;
//      window.onresize = function (e) {
//        method();
//      };
      method();
    },
    methods: {
      setCtxHeight() {
        let height = (document.documentElement.clientHeight || document.body.clientHeight) - 90;
        document.getElementById('container').style.height = height + 'px';
        this.height = height;
      },
      showPwdDialog() {
        if (this.$refs['pwdForm'] && this.$refs['pwdForm'].resetFields) {
          this.$refs['pwdForm'].resetFields();
        }
        this.pwd.show = true;
      },
      submitPwdForm() {
        this.$refs['pwdForm'].validate((valid) => {
          if (valid) {
            api.modifyPwd(this.pwd.form).then((res) => {
              let data = res.data;
              if (data && data.code === '0') {
                this.$message({
                  type: 'success',
                  message: '密码修改成功!'
                });
                this.pwd.show = false;
              }
            });
          } else {
            return false;
          }
        });
      },
      switchModule(key) {
        this.$emit('switchModule', key);
      },
      switchCompany(item) {
        this.$emit('switchCompany', item);
      },
      logout () {
        this.$emit('logout');
      },
      handleBreads (data) {
        this.breads = data;
      },
      handleCollapse () {
        this.collapse = !this.collapse;
      }
    }
  };
</script>
