<template>
  <Layout @switchCompany="switchCompany"
          @switchModule="switchModule"
          @logout="logout"
          :menus="menus"
          :modules="modules"
          :loginUserInfo="loginUserInfo"
          :companies="companies"
          :company="company"></Layout>
</template>
<script>
  import Layout from '../components/layout/index.vue';
  import util from '../util';
  export default {
    name: 'bsmp',
    components: {Layout},
    data() {
      return {
        currPath: null, // 当前地址栏路径
        oldMenus: []
      };
    },
    mounted() {
      // 更改背景颜色
      document.body.style.backgroundColor = '#fbfbfb';

      if (!this.$store.state.auth.user) {
        let user = window.sessionStorage.getItem('user');
        if (user) {
          user = JSON.parse(user);
          this.$store.commit('LOGIN_SUCCESS', user);

          let systemFlag = '';
          if (this.$route.path !== '/index') {
            systemFlag = window.sessionStorage.getItem('systemFlag');
          }
          this.getMenus(systemFlag || '');
          // 请求系统公司列表
          this.getCompanies();
        } else {
          location.href = '/#/login';
        }
      } else {
        this.getMenus('');
        // 请求系统公司列表
        this.getCompanies();
      }
    },
    methods: {
      switchModule(key) {
        this.oldMenus = [].concat(this.menus);

        window.sessionStorage.setItem('systemFlag', key);
        this.getMenus(key);
      },
      switchCompany(item) {
        this.$store.commit('SWITCH_COMPANY', item);
        this.$message.success('公司切换成功！');
      },
      logout() {
        this.$confirm('你确定退出登录么?', '确认退出', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.$store.dispatch('logout', {token: this.$store.state.auth.user.data.tokenVal.token});
          window.sessionStorage.clear();
          location.href = '/#/login';
        }).catch(e => {
        });
      },
      getMenus(systemFlag) {
        let user = this.$store.state.auth.user;
        if (user && user.data && user.data.roleCode) {
          let params = {
            roleCode: user.data.roleCode,
            hasAuth: true
          };
          if (systemFlag) {
            params.systemFlag = systemFlag;
          }
          // 请求菜单栏数据
          this.$store.dispatch('getMenus', params);
        }
      },
      getCompanies() {
        let user = this.$store.state.auth.user;
        if (user && user.data && user.data.roleCode && user.data.roleCode === 'ALL') {
          this.$store.dispatch('getCompanies');
        }
      }
    },
    computed: {
      menus() {
        return this.$store.getters.menus;
      },
      modules() {
        return this.$store.getters.modules;
      },
      loginUserInfo () {
        let loginUser = this.$store.getters.loginUser;
        let info = {name: '', email: ''};
        if (loginUser && loginUser.data) {
          if (loginUser.data.loginName) {
            info.name = loginUser.data.loginName;
          }
          if (loginUser.data.email) {
            info.email = loginUser.data.email;
          }
          if (loginUser.data.roleCode) {
            info.roleCode = loginUser.data.roleCode;
          }
          if (loginUser.data.companyId) {
            info.companyId = loginUser.data.companyId;
          }
        }
        return info;
      },
      companies() {
        return this.$store.getters.companies;
      },
      company() {
        return this.$store.getters.company;
      }
    },
    watch: {
      menus(newValue, oldValue) {
        if (newValue.length && this.oldMenus.length) {
          if (newValue[0].children && newValue[0].children.length
            && newValue[0].children[0].path) {
            location.href = '#' + newValue[0].children[0].path;
          }
        }
      }
    }
  };
</script>
